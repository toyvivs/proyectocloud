<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Acceso RFID</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    h1 {
      margin-top: 40px;
      font-size: 2.5em;
      color: #2c3e50;
    }

    .card {
      margin: 40px auto;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
      background-color: #fff;
    }

    .zona {
      font-size: 1.5em;
      color: #555;
      margin-bottom: 10px;
    }

    .mensaje {
      font-size: 2em;
      font-weight: bold;
      padding: 20px;
      border-radius: 12px;
      color: #fff;
    }

    .autorizado {
      background-color: #28a745;
    }

    .denegado {
      background-color: #dc3545;
    }

    .esperando {
      background-color: #999;
    }

    .nombre {
      margin-top: 10px;
      font-size: 1.2em;
      color: #333;
    }

    .error {
      color: red;
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Acerque tarjeta al sensor</h1>

  <div class="card">
    <div class="zona" id="zona">Esperando lectura...</div>
    <div class="mensaje esperando" id="mensaje">Esperando...</div>
    <div class="nombre" id="nombre"></div>
  </div>

  <div id="error" class="error"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAAsaf9Xqi1sMGUmC606xh-wFpOQr0UxKQ",
      authDomain: "database-72189.firebaseapp.com",
      databaseURL: "https://database-72189-default-rtdb.firebaseio.com",
      projectId: "database-72189",
      storageBucket: "database-72189.appspot.com",
      messagingSenderId: "444896561881",
      appId: "1:444896561881:web:1d51ab7cd3a8e9b0ca4cc8",
      measurementId: "G-0V5TV38RQS"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const zonas = [
      { nombre: "almacen", ruta: "accesos/almacen" },
      { nombre: "oficina", ruta: "accesos/oficina" },
      { nombre: "mostrador", ruta: "registros/mostrador" }
    ];

    const zonaDiv = document.getElementById('zona');
    const mensajeDiv = document.getElementById('mensaje');
    const nombreDiv = document.getElementById('nombre');
    const errorDiv = document.getElementById('error');

    async function getLastRegistro(ruta) {
      try {
        const res = await fetch(`https://database-72189-default-rtdb.firebaseio.com/${ruta}.json`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

        const data = await res.json();
        console.log(`Datos recibidos de ${ruta}:`, data);

        if (!data) return null;

        const keys = Object.keys(data);
        if(keys.length === 0) return null;

        const lastKey = keys[keys.length - 1];
        return { ...data[lastKey], timestamp: data[lastKey].timestamp || 0 };
      } catch (error) {
        console.error("Error obteniendo datos de Firebase:", error);
        errorDiv.textContent = `Error al obtener datos de ${ruta}: ${error.message}`;
        return null;
      }
    }

    async function verificarAcceso() {
      errorDiv.textContent = ''; // limpia errores cada ciclo

      let ultimo = null;

      for (let z of zonas) {
        const reg = await getLastRegistro(z.ruta);
        if (reg && (!ultimo || reg.timestamp > ultimo.timestamp)) {
          ultimo = { ...reg, zona: z.nombre };
        }
      }

      if (ultimo) {
        zonaDiv.textContent = `Zona: ${ultimo.zona.toUpperCase()}`;
        nombreDiv.textContent = ultimo.nombre ? `Nombre: ${ultimo.nombre}` : "";

        if (ultimo.mensaje && ultimo.mensaje.toLowerCase().includes("autorizado")) {
          mensajeDiv.textContent = "✅ Bienvenido";
          mensajeDiv.className = "mensaje autorizado";
        } else {
          mensajeDiv.textContent = "❌ Acceso denegado";
          mensajeDiv.className = "mensaje denegado";
        }
      } else {
        zonaDiv.textContent = "Esperando lectura...";
        mensajeDiv.textContent = "Esperando...";
        mensajeDiv.className = "mensaje esperando";
        nombreDiv.textContent = "";
      }
    }

    setInterval(verificarAcceso, 2000);
    verificarAcceso();
  </script>
</body>
</html>
